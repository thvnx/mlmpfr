name: mlmpfr CI

on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 0' # weekly

jobs:
  main:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        ocaml-compiler: [4.14.0, 5.0.0, 5.2.0]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use OCaml ${{ matrix.ocaml-compiler }}
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: ${{ matrix.ocaml-compiler }}

      # Even if setup-ocaml automatically installs mlmpfr dependencies (i.e.: gmp/mpfr),
      # build mpfr from sources on Ubuntu 22.04 because mpfr 4.2.0 is not the version
      # present in the ubuntu repository. That will be the case for Ubuntu 24.04 but the
      # GitHub image is not working yet with the ocaml-setup step
      # (https://github.com/actions/runner-images/issues/10476).
      #
      # Rely on dune configurator for C and link flags.
      - name: Build mpfr from sources
        if: runner.os == 'linux'
        run: |
          sudo apt remove libmpfr-dev
          wget --no-check-certificate https://www.mpfr.org/mpfr-4.2.2/mpfr-4.2.2.tar.gz
          tar xvzf mpfr-4.2.2.tar.gz
          mkdir build-mpfr
          pushd build-mpfr
          ../mpfr-4.2.2/configure
          make -j8
          sudo make install
          popd

      - name: Build and test mlmpfr
        run: |
          opam install . --deps-only --with-doc --with-test
          opam exec -- dune build @install --profile dev
          opam exec -- dune build @runtest --profile dev --verbose
          opam exec -- dune build @doc
          opam exec -- dune install
          opam exec -- dune exec examples/example.exe
